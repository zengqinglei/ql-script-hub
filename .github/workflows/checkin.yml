name: 签到任务

on:
  # 定时任务（使用 cron 表达式，UTC 时间）
  schedule:
    # 每天 UTC 0:30 (北京时间 8:30) 执行
    - cron: '30 0 * * *'
    # 每天 UTC 9:30 (北京时间 17:30) 执行
    - cron: '30 9 * * *'

  # 手动触发
  workflow_dispatch:
    inputs:
      run_all:
        description: '是否运行所有脚本'
        required: true
        default: true
        type: boolean
      script_name:
        description: '选择要运行的单个脚本（仅当"是否运行所有"为false时生效）'
        required: false
        default: 'ikuuu'
        type: choice
        options:
          - ikuuu
          - leaflow
          - aliyunpan
          - anyrouter
          - agentrouter
          - youdaoyun
          - baiduwangpan
          - quark
          - nodeseek
          - deepflood
          - nga
          - tieba
          - smzdm
          - ty_netdisk
          - sfsu
          - enshan

jobs:
  checkin:
    runs-on: ubuntu-latest
    # 声明工作流的默认权限
    permissions:
      contents: write # 允许写入内容，用于后续自动提交数据
    # 指定运行环境（可选，但属良好实践）
    environment: production

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # 启用 pip 缓存
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip --quiet
          if [ -f requirements.txt ]; then pip install -r requirements.txt --quiet; fi

      - name: 获取 Playwright 版本
        id: playwright-version
        run: |
          # 从元数据中读取 playwright 版本，用于缓存 key
          PLAYWRIGHT_VERSION=$(python -c "from importlib.metadata import version; print(version('playwright'))")
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "Playwright version: $PLAYWRIGHT_VERSION"

      - name: 缓存 Playwright 浏览器
        id: playwright-cache
        uses: actions/cache@v4
        with:
          # Playwright 浏览器的默认缓存路径
          path: ~/.cache/ms-playwright
          # 基于操作系统、Playwright 版本创建缓存键
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
          # 如果当前键找不到，则使用旧的缓存
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: 安装 Playwright 浏览器
        # 仅在缓存未命中时执行
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          playwright install chromium --with-deps

      - name: 准备通知模块
        run: |
          # 复制 notify.py 到根目录，供签到脚本使用
          cp .github/workflows/notify.py ./notify.py
          echo "通知模块准备就绪"

      - name: 连接到 Cloudflare WARP
        uses: fscarmen/warp-on-actions@v1.3
        with:
          mode: client

      - name: 运行签到脚本
        env:
          # 全局配置
          PRIVACY_MODE: ${{ secrets.PRIVACY_MODE }}

          # 通知配置
          PUSH_KEY: ${{ secrets.PUSH_KEY }}
          QYWX_KEY: ${{ secrets.QYWX_KEY }}
          HITOKOTO: 'false'

          # iKuuu 配置
          IKUUU_EMAIL: ${{ secrets.IKUUU_EMAIL }}
          IKUUU_PASSWD: ${{ secrets.IKUUU_PASSWD }}

          # Leaflow 配置
          LEAFLOW_COOKIE: ${{ secrets.LEAFFLOW_COOKIE }}

          # 阿里云盘配置
          ALIYUN_REFRESH_TOKEN: ${{ secrets.ALIYUN_REFRESH_TOKEN }}
          AUTO_UPDATE_TOKEN: ${{ secrets.AUTO_UPDATE_TOKEN }}

          # AnyRouter 配置
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
          ANYROUTER_BASE_URL: ${{ secrets.ANYROUTER_BASE_URL }}

          # 有道云笔记配置
          YOUDAO_COOKIE: ${{ secrets.YOUDAO_COOKIE }}

          # AgentRouter 配置
          AGENTROUTER_ACCOUNTS: ${{ secrets.AGENTROUTER_ACCOUNTS }}
          BROWSER_HEADLESS: 'true'

          # 百度网盘配置
          BAIDU_COOKIE: ${{ secrets.BAIDU_COOKIE }}

          # 夸克网盘配置
          QUARK_COOKIE: ${{ secrets.QUARK_COOKIE }}
        run: |
          set +x  # 关闭命令回显

          echo "=========================================="
          echo "开始执行签到任务"
          echo "当前时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

          # 获取用户输入
          RUN_ALL="${{ github.event.inputs.run_all }}"
          SCRIPT_NAME="${{ github.event.inputs.script_name }}"

          # 如果是定时任务触发（没有输入参数），默认运行所有
          if [ -z "$RUN_ALL" ]; then
            RUN_ALL="true"
          fi

          # 根据选择确定要运行的脚本
          if [ "$RUN_ALL" = "true" ]; then
            SCRIPTS_INPUT="all"
            echo "运行模式: 所有脚本"
          else
            SCRIPTS_INPUT="$SCRIPT_NAME"
            echo "运行模式: 单个脚本 - $SCRIPT_NAME"
          fi

          echo ""

          # 定义函数：检查环境变量是否存在
          check_env() {
            local env_name=$1
            if [ -n "${!env_name}" ]; then
              return 0  # 环境变量存在
            else
              return 1  # 环境变量不存在
            fi
          }

          # 定义函数：检查脚本所需的环境变量是否已配置
          check_script_env() {
            local script_name=$1
            shift
            local required_envs=("$@")

            for env in "${required_envs[@]}"; do
              if check_env "$env"; then
                return 0  # 至少有一个环境变量存在，可以运行
              fi
            done
            return 1  # 所有环境变量都不存在
          }

          # 定义函数：判断是否应该运行该脚本
          should_run() {
            local script_name=$1

            # 如果是 all 或 ALL，需要检查环境变量
            if [ "$SCRIPTS_INPUT" = "all" ] || [ "$SCRIPTS_INPUT" = "ALL" ]; then
              return 0  # 返回 0 表示需要进一步检查环境变量
            fi

            # 检查脚本名是否在输入列表中（支持逗号分隔）
            if echo ",$SCRIPTS_INPUT," | grep -q ",$script_name,"; then
              return 0
            fi

            return 1  # 不在列表中
          }

          # 定义函数：运行脚本
          run_script() {
            local script_name=$1
            local script_file=$2
            shift 2
            local required_envs=("$@")

            # 判断是否应该运行
            if ! should_run "$script_name"; then
              return
            fi

            # 检查脚本文件是否存在
            if [ ! -f "$script_file" ]; then
              echo "脚本文件不存在: $script_file"
              return
            fi

            # 如果是 all 模式，检查环境变量
            if [ "$SCRIPTS_INPUT" = "all" ] || [ "$SCRIPTS_INPUT" = "ALL" ]; then
              if ! check_script_env "$script_name" "${required_envs[@]}"; then
                echo "跳过 $script_name: 未配置环境变量"
                return
              fi
            fi

            echo ""
            echo "=========================================="
            echo "开始执行: $script_name"
            echo "=========================================="

            # 直接执行脚本，让脚本的Logger输出正常显示
            if python "$script_file"; then
              echo "$script_name 执行成功"
            else
              echo "$script_name 执行失败（退出码: $?）"
            fi
          }

          # 执行各个签到脚本（每个脚本后面跟上其必需的环境变量）
          run_script "ikuuu" "ikuuu_checkin.py" "IKUUU_EMAIL" "IKUUU_PASSWD"
          run_script "leaflow" "leafflow_checkin.py" "LEAFLOW_COOKIE"
          run_script "aliyunpan" "aliyunpan_checkin.py" "ALIYUN_REFRESH_TOKEN"
          run_script "anyrouter" "anyrouter_checkin.py" "ANYROUTER_ACCOUNTS"
          run_script "youdaoyun" "youdaoyun_checkin.py" "YOUDAO_COOKIE"
          run_script "baiduwangpan" "baiduwangpan_checkin.py" "BAIDU_COOKIE"
          run_script "quark" "quark_checkin.py" "QUARK_COOKIE"
          run_script "nodeseek" "nodeseek_checkin.py" "NODESEEK_COOKIE"
          run_script "deepflood" "deepflood_checkin.py" "DEEPFLOOD_COOKIE"
          run_script "nga" "nga_checkin.py" "NGA_COOKIE"
          run_script "tieba" "tieba_checkin.py" "TIEBA_COOKIE"
          run_script "smzdm" "SMZDM_checkin.py" "SMZDM_COOKIE"
          run_script "ty_netdisk" "ty_netdisk_checkin.py" "TY_NETDISK_COOKIE"
          run_script "sfsu" "SFSU_checkin.py" "SFSU_COOKIE"
          run_script "enshan" "enshan_checkin.py" "ENSHAN_COOKIE"
          run_script "agentrouter" "agentrouter_checkin.py" "AGENTROUTER_ACCOUNTS"

          echo ""
          echo "=========================================="
          echo "所有签到任务执行完成"
          echo "完成时间: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

      - name: 自动更新 GitHub Secrets
        if: always()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 如果配置了 GH_PAT，则尝试自动更新 Secrets
          if [ -n "$GH_PAT" ]; then
            echo "开始自动更新 GitHub Secrets..."
            python .github/workflows/update_secrets.py
          else
            echo "未配置 GH_PAT，跳过自动更新 Secrets"
          fi

      - name: 保存日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkin-logs-${{ github.run_number }}
          path: |
            *.log
            **/*.log
          retention-days: 7

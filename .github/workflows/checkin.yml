name: ç­¾åˆ°ä»»åŠ¡

on:
  # å®šæ—¶ä»»åŠ¡ï¼ˆä½¿ç”¨ cron è¡¨è¾¾å¼ï¼ŒUTC æ—¶é—´ï¼‰
  schedule:
    # æ¯å¤© UTC 0:50 (åŒ—äº¬æ—¶é—´ 8:50) æ‰§è¡Œ
    - cron: '50 0 * * *'
    # æ¯å¤© UTC 9:30 (åŒ—äº¬æ—¶é—´ 17:30) æ‰§è¡Œ
    - cron: '30 9 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      run_all:
        description: 'æ˜¯å¦è¿è¡Œæ‰€æœ‰è„šæœ¬'
        required: true
        default: true
        type: boolean
      script_name:
        description: 'é€‰æ‹©è¦è¿è¡Œçš„å•ä¸ªè„šæœ¬ï¼ˆä»…å½“"æ˜¯å¦è¿è¡Œæ‰€æœ‰"ä¸ºfalseæ—¶ç”Ÿæ•ˆï¼‰'
        required: false
        default: 'ikuuu'
        type: choice
        options:
          - ikuuu
          - leaflow
          - aliyunpan
          - anyrouter
          - agentrouter
          - youdaoyun
          - baiduwangpan
          - quark
          - nodeseek
          - deepflood
          - nga
          - tieba
          - smzdm
          - ty_netdisk
          - sfsu
          - enshan

jobs:
  checkin:
    runs-on: ubuntu-latest
    # å£°æ˜å·¥ä½œæµçš„é»˜è®¤æƒé™
    permissions:
      contents: write # å…è®¸å†™å…¥å†…å®¹ï¼Œç”¨äºåç»­è‡ªåŠ¨æäº¤æ•°æ®
    # æŒ‡å®šè¿è¡Œç¯å¢ƒï¼ˆå¯é€‰ï¼Œä½†å±è‰¯å¥½å®è·µï¼‰
    environment: production

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          # å¯ç”¨ pip ç¼“å­˜
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: è·å– Playwright ç‰ˆæœ¬
        id: playwright-version
        run: |
          # ä»å…ƒæ•°æ®ä¸­è¯»å– playwright ç‰ˆæœ¬ï¼Œç”¨äºç¼“å­˜ key
          PLAYWRIGHT_VERSION=$(python -c "from importlib.metadata import version; print(version('playwright'))")
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "Playwright version: $PLAYWRIGHT_VERSION"

      - name: ç¼“å­˜ Playwright æµè§ˆå™¨
        id: playwright-cache
        uses: actions/cache@v4
        with:
          # Playwright æµè§ˆå™¨çš„é»˜è®¤ç¼“å­˜è·¯å¾„
          path: ~/.cache/ms-playwright
          # åŸºäºæ“ä½œç³»ç»Ÿã€Playwright ç‰ˆæœ¬åˆ›å»ºç¼“å­˜é”®
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
          # å¦‚æœå½“å‰é”®æ‰¾ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨æ—§çš„ç¼“å­˜
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: å®‰è£… Playwright æµè§ˆå™¨
        # ä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶æ‰§è¡Œ
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          playwright install chromium --with-deps

      - name: å‡†å¤‡é€šçŸ¥æ¨¡å—
        run: |
          # å¤åˆ¶ notify.py åˆ°æ ¹ç›®å½•ï¼Œä¾›ç­¾åˆ°è„šæœ¬ä½¿ç”¨
          cp .github/workflows/notify.py ./notify.py
          echo "âœ… notify.py å·²å‡†å¤‡å°±ç»ª"

      - name: è¿æ¥åˆ° Cloudflare WARP
        uses: fscarmen/warp-on-actions@v1.3
        with:
          mode: client

      - name: è¿è¡Œç­¾åˆ°è„šæœ¬
        env:
          # å…¨å±€é…ç½®
          PRIVACY_MODE: ${{ secrets.PRIVACY_MODE }}
          RANDOM_SIGNIN: ${{ secrets.RANDOM_SIGNIN }}
          MAX_RANDOM_DELAY: ${{ secrets.MAX_RANDOM_DELAY }}

          # é€šçŸ¥é…ç½®
          PUSH_KEY: ${{ secrets.PUSH_KEY }}
          QYWX_KEY: ${{ secrets.QYWX_KEY }}
          HITOKOTO: 'false'

          # iKuuu é…ç½®
          IKUUU_EMAIL: ${{ secrets.IKUUU_EMAIL }}
          IKUUU_PASSWD: ${{ secrets.IKUUU_PASSWD }}

          # Leaflow é…ç½®
          LEAFLOW_COOKIE: ${{ secrets.LEAFLOW_COOKIE }}

          # é˜¿é‡Œäº‘ç›˜é…ç½®
          ALIYUN_REFRESH_TOKEN: ${{ secrets.ALIYUN_REFRESH_TOKEN }}
          AUTO_UPDATE_TOKEN: ${{ secrets.AUTO_UPDATE_TOKEN }}

          # AnyRouter é…ç½®
          ANYROUTER_ACCOUNTS: ${{ secrets.ANYROUTER_ACCOUNTS }}
          ANYROUTER_BASE_URL: ${{ secrets.ANYROUTER_BASE_URL }}

          # æœ‰é“äº‘ç¬”è®°é…ç½®
          YOUDAO_COOKIE: ${{ secrets.YOUDAO_COOKIE }}

          # AgentRouter é…ç½®
          AGENTROUTER_ACCOUNTS: ${{ secrets.AGENTROUTER_ACCOUNTS }}
          BROWSER_HEADLESS: 'true'

          # ç™¾åº¦ç½‘ç›˜é…ç½®
          BAIDU_COOKIE: ${{ secrets.BAIDU_COOKIE }}

          # å¤¸å…‹ç½‘ç›˜é…ç½®
          QUARK_COOKIE: ${{ secrets.QUARK_COOKIE }}
        run: |
          echo "=========================================="
          echo "å¼€å§‹æ‰§è¡Œç­¾åˆ°ä»»åŠ¡"
          echo "å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

          # è·å–ç”¨æˆ·è¾“å…¥
          RUN_ALL="${{ github.event.inputs.run_all }}"
          SCRIPT_NAME="${{ github.event.inputs.script_name }}"

          # å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆæ²¡æœ‰è¾“å…¥å‚æ•°ï¼‰ï¼Œé»˜è®¤è¿è¡Œæ‰€æœ‰
          if [ -z "$RUN_ALL" ]; then
            RUN_ALL="true"
          fi

          # æ ¹æ®é€‰æ‹©ç¡®å®šè¦è¿è¡Œçš„è„šæœ¬
          if [ "$RUN_ALL" = "true" ]; then
            SCRIPTS_INPUT="all"
            echo "ğŸ“‹ è¿è¡Œæ¨¡å¼: æ‰€æœ‰è„šæœ¬"
          else
            SCRIPTS_INPUT="$SCRIPT_NAME"
            echo "ğŸ“‹ è¿è¡Œæ¨¡å¼: å•ä¸ªè„šæœ¬ - $SCRIPT_NAME"
          fi

          echo ""

          # å®šä¹‰å‡½æ•°ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
          check_env() {
            local env_name=$1
            if [ -n "${!env_name}" ]; then
              return 0  # ç¯å¢ƒå˜é‡å­˜åœ¨
            else
              return 1  # ç¯å¢ƒå˜é‡ä¸å­˜åœ¨
            fi
          }

          # å®šä¹‰å‡½æ•°ï¼šæ£€æŸ¥è„šæœ¬æ‰€éœ€çš„ç¯å¢ƒå˜é‡æ˜¯å¦å·²é…ç½®
          check_script_env() {
            local script_name=$1
            shift
            local required_envs=("$@")

            for env in "${required_envs[@]}"; do
              if check_env "$env"; then
                return 0  # è‡³å°‘æœ‰ä¸€ä¸ªç¯å¢ƒå˜é‡å­˜åœ¨ï¼Œå¯ä»¥è¿è¡Œ
              fi
            done
            return 1  # æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½ä¸å­˜åœ¨
          }

          # å®šä¹‰å‡½æ•°ï¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥è¿è¡Œè¯¥è„šæœ¬
          should_run() {
            local script_name=$1

            # å¦‚æœæ˜¯ all æˆ– ALLï¼Œéœ€è¦æ£€æŸ¥ç¯å¢ƒå˜é‡
            if [ "$SCRIPTS_INPUT" = "all" ] || [ "$SCRIPTS_INPUT" = "ALL" ]; then
              return 0  # è¿”å› 0 è¡¨ç¤ºéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ç¯å¢ƒå˜é‡
            fi

            # æ£€æŸ¥è„šæœ¬åæ˜¯å¦åœ¨è¾“å…¥åˆ—è¡¨ä¸­ï¼ˆæ”¯æŒé€—å·åˆ†éš”ï¼‰
            if echo ",$SCRIPTS_INPUT," | grep -q ",$script_name,"; then
              return 0
            fi

            return 1  # ä¸åœ¨åˆ—è¡¨ä¸­
          }

          # å®šä¹‰å‡½æ•°ï¼šè¿è¡Œè„šæœ¬
          run_script() {
            local script_name=$1
            local script_file=$2
            shift 2
            local required_envs=("$@")

            # åˆ¤æ–­æ˜¯å¦åº”è¯¥è¿è¡Œ
            if ! should_run "$script_name"; then
              return
            fi

            # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$script_file" ]; then
              echo "âš ï¸ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $script_file"
              return
            fi

            # å¦‚æœæ˜¯ all æ¨¡å¼ï¼Œæ£€æŸ¥ç¯å¢ƒå˜é‡
            if [ "$SCRIPTS_INPUT" = "all" ] || [ "$SCRIPTS_INPUT" = "ALL" ]; then
              if ! check_script_env "$script_name" "${required_envs[@]}"; then
                echo "â­ï¸  è·³è¿‡ $script_name: æœªé…ç½®æ‰€éœ€ç¯å¢ƒå˜é‡ (${required_envs[*]})"
                return
              fi
            fi

            echo ""
            echo "=========================================="
            echo "ğŸš€ å¼€å§‹æ‰§è¡Œ: $script_name"
            echo "=========================================="

            if python "$script_file"; then
              echo "âœ… $script_name æ‰§è¡ŒæˆåŠŸ"
            else
              echo "âŒ $script_name æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç : $?ï¼‰"
            fi
          }

          # æ‰§è¡Œå„ä¸ªç­¾åˆ°è„šæœ¬ï¼ˆæ¯ä¸ªè„šæœ¬åé¢è·Ÿä¸Šå…¶å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼‰
          run_script "ikuuu" "ikuuu_checkin.py" "IKUUU_EMAIL" "IKUUU_PASSWD"
          run_script "leaflow" "leaflow_checkin.py" "LEAFLOW_COOKIE"
          run_script "aliyunpan" "aliyunpan_checkin.py" "ALIYUN_REFRESH_TOKEN"
          run_script "anyrouter" "anyrouter_checkin.py" "ANYROUTER_ACCOUNTS"
          run_script "youdaoyun" "youdaoyun_checkin.py" "YOUDAO_COOKIE"
          run_script "baiduwangpan" "baiduwangpan_checkin.py" "BAIDU_COOKIE"
          run_script "quark" "quark_checkin.py" "QUARK_COOKIE"
          run_script "nodeseek" "nodeseek_checkin.py" "NODESEEK_COOKIE"
          run_script "deepflood" "deepflood_checkin.py" "DEEPFLOOD_COOKIE"
          run_script "nga" "nga_checkin.py" "NGA_COOKIE"
          run_script "tieba" "tieba_checkin.py" "TIEBA_COOKIE"
          run_script "smzdm" "SMZDM_checkin.py" "SMZDM_COOKIE"
          run_script "ty_netdisk" "ty_netdisk_checkin.py" "TY_NETDISK_COOKIE"
          run_script "sfsu" "SFSU_checkin.py" "SFSU_COOKIE"
          run_script "enshan" "enshan_checkin.py" "ENSHAN_COOKIE"
          run_script "agentrouter" "agentrouter_checkin.py" "AGENTROUTER_ACCOUNTS"

          echo ""
          echo "=========================================="
          echo "æ‰€æœ‰ç­¾åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
          echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

      - name: è‡ªåŠ¨æ›´æ–° GitHub Secrets
        if: always()
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¦‚æœé…ç½®äº† GH_PATï¼Œåˆ™å°è¯•è‡ªåŠ¨æ›´æ–° Secrets
          if [ -n "$GH_PAT" ]; then
            echo "ğŸ”„ å¼€å§‹è‡ªåŠ¨æ›´æ–° GitHub Secrets..."
            python .github/workflows/update_secrets.py
          else
            echo "âš ï¸ æœªé…ç½® GH_PATï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–° Secrets"
            echo "ğŸ’¡ å¦‚éœ€è‡ªåŠ¨æ›´æ–°ç¯å¢ƒå˜é‡ï¼Œè¯·å‚è€ƒæ–‡æ¡£é…ç½® GH_PAT"
          fi

      - name: ä¿å­˜æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkin-logs-${{ github.run_number }}
          path: |
            *.log
            **/*.log
          retention-days: 7
